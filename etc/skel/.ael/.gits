#! /usr/bin/env sh
## ----------------------------------------------------------------------- INFO
## [.ael/.gits]
## author        = "fantomH @alterEGO Linux"
## created       = 2022-10-18 22:14:48 UTC
## updated       = 2023-08-02 20:01:58 UTC
## description   = "Shell stuff for git."

[ -f ${HOME}/.ael/bash-ael/messages.bash ]                                    \
&& . ${HOME}/.ael/bash-ael/messages.bash

## -------------------- [ gitall ]                                          {{{
## [gitall()]
## version       = 2023-08-02 20:04:33 UTC
## description   = "Fast update of git repo."

gitall() {

    git pull && git add . && git commit && git push
  }
  ## }}}

## -------------------- [ git-status ]                                      {{{
## [git-status()]
## version       = 2023-08-02 20:06:20 UTC
## description   = "Get status of local git repository."
## notes         = '''
## ref. https://gist.github.com/giggio/1704664
## '''

git_status() {

    dumpfile="/tmp/git-status.dump"

    if [ -z ${1} ]; then
      local_git_repository=$(find ${HOME} -name ".git" -type d | grep -v /.cache/ | sed 's/.git//' | fzf)
    else
      local_git_repository=${1}
    fi
    
    cd ${local_git_repository}
    git fetch
    git status > ${dumpfile}

    message action "Checking local repository status for\n    ${local_git_repository}"

    untracked=$(grep "Untracked files" ${dumpfile});
    unstaged=$(grep "Changes not staged for commit" ${dumpfile});
    to_commit=$(grep "Changes to be committed" ${dumpfile});
    is_ahead=$(grep "Your branch is ahead of" ${dumpfile});
    is_behind=$(grep "Your branch is behind" ${dumpfile});

    if [[ -n "${untracked}" ]]; then
      message result "ADD Files to add to repo."
    elif [[ -n ${unstaged} ]]; then
      message result "ADD Files to be staged."
    elif [[ -n "${to_commit}" ]]; then
      message result "COMMIT Files to commit."
    elif [[ -n "${is_ahead}" ]]; then
      message result "PUSH Time to push."
    elif [[ -n "${is_behind}" ]]; then
      message result "PULL Time to pull."
    else
      message result "STAY Nothing to do."
    fi
  }
  alias git-status='git_status'
  ## }}}

## -------------------- [ lazygit ]                                         {{{
## [lazygit]
## version       = 2023-08-02 20:08:41 UTC
## notes         = '''
## The variable lazygit_repositories is defined in ~/.ael/.extra
## '''

lazygit() {

    if [[ ! -e "${lazygit_repositories}" ]]; then
        message warning "Please define `lazygit_repositories` in `~/.ael/.extra`."
    fi

    _cwd="$(pwd)"
    cd ${HOME}
    for repo in "${lazygit_repositories[@]}"; do
        message action "Updating $repo"
        cd "$repo"
        git pull                                                              \
        && git add .                                                          \
        && git commit -m "Updated using lazygit..."                           \
        && git push
        cd ${HOME}
    done
    cd "$_cwd"
  }
  ## }}}

# vim: syntax=sh
# vim: foldmethod=marker
## ------------------------------------------------------------- FIN ¯\_(ツ)_/¯
