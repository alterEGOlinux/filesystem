#!/usr/bin/env bash

## ----------------------------------------------------------------------------
##             { alterEGO Linux: "Open the vault of knowledge" }             ##
## ----------------------------------------------------------------------------
##
## ~/.ael/.tryhackme
##   created        : 2021-03-07 15:10:11 UTC
##   updated        : 2022-11-23 11:50:13 UTC
##   description    : TryHackMe stuff.
## ____________________________________________________________________________

## [-- MODULES --]

  [ -f ${HOME}/.ael/bash-ael/messages.bash ]                                  \
  && . ${HOME}/.ael/bash-ael/messages.bash

  ## ( PREPARATION )

  _CONFIGDIR="${HOME}/.alterEGO/tryhackme"
  if [ ! -d ${_CONFIGDIR} ]; then
    mkdir ${_CONFIGDIR}
  fi

  _MAINDIR="${HOME}/.tryhackme"
  if [ ! -d ${_MAINDIR} ]; then
    mkdir ${_MAINDIR}
  fi

  _CONFIG="${_CONFIGDIR}/.tryhackme.cfg"
  if [ ! -e ${_CONFIG} ]; then
    message question "Player name?"
    _THMPLAYER="${_INPUT}"

    message question "Room name?"
    _THMROOM="${_INPUT}"

    message question "Remote host IP?"
    _THMRHOST="${_INPUT}"

    message question "Local host IP?"
    _THMLHOST="${_INPUT}"

    cat <<EOF> ${_CONFIG}
THMPLAYER="${_THMPLAYER}"
THMROOM="${_THMROOM}"
THMRHOST="${_THMRHOST}"
THMLHOST="${_THMLHOST}"
EOF
  fi

  [ -f ${_CONFIG} ]                                                           \
  && . ${_CONFIG}

## [ COMPLETION ] ---------------------------------------------------------- ##

  for x in attack .tryhackme; do
    options="\
            connect
            help
            info
            login 
            msf
            set-lhost
            set-player
            set-rhost
            set-room
            usage
            webroom" 
    complete -W "${options[@]}" $x
  done

## [ FUNCTIONS ] ----------------------------------------------------------- ##

  set_path() {
    THMPATH="${_MAINDIR}/${THMROOM}"

    if [ ! -d ${THMPATH} ]; then
      mkdir ${THMPATH}
    fi

    export THMPATH
  }

  set_msf() {

    ## ( METASPLOIT )
    ## Create msfconsole resource file.
    ## This can be loaded using:
    ## msf -r ~/.msf4/<resourcefile.rc>
    ## Or sourced directly in msf using:
    ## `resource thm.rc`

    if [ ! -d "${HOME}/.msf4" ]; then
      mkdir ${HOME}/.msf4
    fi

    cat << EOF > ~/.msf4/thm.rc
load alias
alias setlhost "set LHOST ${THMLHOST}"
alias setrhost "set RHOSTS ${THMRHOST}"
EOF
  }

## [ VARIABLES ] ----------------------------------------------------------- ##

  export THMPLAYER
  export THMROOM
  export THMRHOST
  export THMLHOST
  set_path

## [ USAGE ] --------------------------------------------------------------- ##

  usage() {
    cat <<EOF
Usage: attack [option]

Options:
  connect
  login
  webroom
  set-player
  set-room
  set-lhost
  set-rhost
  info
  msf
  help/usage

EOF
  }

## [ OPTIONS ] ------------------------------------------------------------- ##

  case "${1}" in

    connect )
      _VPN="${_CONFIGDIR}/${THMPLAYER}.ovpn"
      if [[ -f ${_VPN} ]]; then
        sudo openvpn ${_VPN} &
        cd ${THMPATH}
        sleep 2
        $BROWSER "https://www.tryhackme.com/room/${THMROOM}"
      else
        $BROWSER "https://tryhackme.com/vpn/get-config"
        cd ${THMPATH}
      fi
      ;;
    login )
      $BROWSER "https://www.tryhackme.com/login"
      ;;
    webroom )
      $BROWSER "https://www.tryhackme.com/room/${THMROOM}"
      ;;
    set-player )
      if [[ ${#} == 2 ]]; then
        shift
        sed -i -e "s/\(THMPLAYER=\).*/\1'${1}'/g" "${_CONFIG}"
        export THMPLAYER="${1}"
      else
        message warning "Nope"
        usage
      fi
      ;;
    set-room )
      if [[ ${#} == 2 ]]; then
        shift
        sed -i -e "s/\(THMROOM=\).*/\1'${1}'/g" "${_CONFIG}"
        export THMROOM="${1}"
        set_path
        cd "${THMPATH}"
      else
        message warning "Nope"
        usage
      fi
      ;;
    set-lhost )
      if [[ ${#} == 2 ]]; then
        shift
        sed -i -e "s/\(THMLHOST=\).*/\1'${1}'/g" "${_CONFIG}"
        export THMRHOST="${1}"
      else
        message warning "Nope"
        usage
      fi
      ;;
    set-rhost )
      if [[ ${#} == 2 ]]; then
        shift
        sed -i -e "s/\(THMLHOST=\).*/\1'${1}'/g" "${_CONFIG}"
        export THMRHOST="${1}"
      else
        message warning "Nope"
        usage
      fi
      ;;
    info )
      env | grep --color=never THM
      ;;
    msf )
      set_msf
      msfconsole -x "db_connect ${USER}@msf" -r ~/.msf4/thm.rc
      ;;
    help|usage )
      usage
      ;;

  esac

## ----------------------------------------------------------------------------
# vim: foldmethod=marker
# vim: syntax=sh
## ___________________________{ FIN ¯\_(ツ)_/¯ }_______________________________
