#! /usr/bin/env sh
## { alterEGO Linux: "Open the vault of knowledge" } ----------------------- ##
##                                                                           ##
## ~/.alterEGO/.functions                                                    ##
##   created        : 2021-05-25 19:40:20 UTC                                ##
##   updated        : 2022-05-25 10:58:08 UTC                                ##
##   description    : Shell functions to complement .egorc                   ##
## _________________________________________________________________________ ##

  busy() {
      ## When the boss comes around to look busy.
      ## ref. https://www.commandlinefu.com/commands/view/6663/pretend-to-be-busy-in-office-to-enjoy-a-cup-of-coffee
      ## CTRL+c to quit.

      cat /dev/urandom                                                        \
      | hexdump -C                                                            \
      | grep --color=always 'ca fe'
  }

  cheat() {
      #:- Query https://cheat.sh.
      #:- Menu with `fzf` and display with `less`.
      #:- https://github.com/chubin/cheat.sh

      cheat="$(curl -s cheat.sh/:list                                         \
              | fzf --layout="reverse"                                        \
                    --prompt='::'                                             \
                    --preview-window=up:80%                                   \
                    --preview 'cat <(curl -s cheat.sh/{})')"

      [[ -z ${cheat} ]] && exit 0

      curl -s cheat.sh/"${cheat}" | less -R
  }

  cleanHistory() {
      ## Remove .bash_history entry.
      ## Usage: `clean_history youtube-dl`
      ## or `clean_history cd$`

      history -a
      cp ~/.bash_history /tmp/.clean_history
      sed -i "/^${1}/d" /tmp/.clean_history
      history -c                                                              \
      && history -r /tmp/.clean_history                                       \
      && history -w
      rm /tmp/.clean_history
      history
  }

  delete() {

      if [ -d "${1}" ]; then
        read -r -p $'\e[34m[-]\e[0m \e[1mAre you sure your want to delete this directory? [y/N]\e[0m ' response
          if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
            rm --recursive --force "${1}" 
          else
            message warning "OK... Abording deletion!"
          fi
      else
        message warning "There is nothing to do here!"
      fi
  }

  dirsize() {
      ## Check size of biggest directories.

      message action "Size of current directory, followed by biggest child directories:"
      ## du -bh --max-depth 1 | sort -rh | head
      du --bytes --human-readable --max-depth 1                               \
      | sort --reverse --human-numeric-sort                                   \
      | head
  }

  fixout() {
      ## Fix history and exit.
      ## Don't try to put this code in a shell script, it won't work.
      ## `history` don't play well in scripts.

      history -n && history                                                   \
      | sort -k2 -k1nr                                                        \
      | uniq -f1                                                              \
      | sort -n                                                               \
      | cut -c8- > ~/.tmp$$                                                   \
      && history -c                                                           \
      && history -r ~/.tmp$$                                                  \
      && history -w                                                           \
      && rm ~/.tmp$$                                                          \
      && exit
  }

  fuck() {
      ## Repeat last cmd with sudo if forgotten.

      sudo $(history -p !!)
  }


  getmp3() {

      youtube-dl -x --audio-format mp3 --prefer-ffmpeg "${1}"

  }

  gitall() {
      git pull && git add . && git commit && git push
  }

  gitstatus() {
      ## Get status of local git repository.
      ## ref. https://gist.github.com/giggio/1704664

      dumpfile="/tmp/gitstatus.dump"

      if [ -z ${1} ]; then
        local_git_repository=$(find ${HOME} -name ".git" -type d | grep -v /.cache/ | sed 's/.git//' | fzf)
      else
        local_git_repository=${1}
      fi
      
      cd ${local_git_repository}
      git fetch
      git status > ${dumpfile}
      printf "${COLOR_GREEN}[+]${COLOR_RESET} ${COLOR_BOLD}Checking local repository status for\n\t${local_git_repository}\n\n${COLOR_RESET}"
      cat ${dumpfile}
      untracked=$(grep "Untracked files" ${dumpfile});
      unstaged=$(grep "Changes not staged for commit" ${dumpfile});
      to_commit=$(grep "Changes to be committed" ${dumpfile});
      is_ahead=$(grep "Your branch is ahead of" ${dumpfile});
      is_behind=$(grep "Your branch is behind" ${dumpfile});
      if [[ -n "${untracked}" ]]; then
        printf "\n${COLOR_BLUE}[-]${COLOR_RESET} ${COLOR_BOLD}ADD Files to add to repo.${COLOR_RESET}\n"
      elif [[ -n ${unstaged} ]]; then
        printf "\n${COLOR_BLUE}[-]${COLOR_RESET} ${COLOR_BOLD}ADD Files to be staged.${COLOR_RESET}\n"
      elif [[ -n "${to_commit}" ]]; then
        printf "\n${COLOR_BLUE}[-]${COLOR_RESET} ${COLOR_BOLD}COMMIT Files to commit.${COLOR_RESET}\n"
      elif [[ -n "${is_ahead}" ]]; then
        printf "\n${COLOR_BLUE}[-]${COLOR_RESET} ${COLOR_BOLD}PUSH Time to push.${COLOR_RESET}\n"
      elif [[ -n "${is_behind}" ]]; then
        printf "\n${COLOR_BLUE}[-]${COLOR_RESET} ${COLOR_BOLD}PULL Time to pull.${COLOR_RESET}\n"
      else
        printf "\n${COLOR_BLUE}[-]${COLOR_RESET} ${COLOR_BOLD}STAY Nothing to do.${COLOR_RESET}\n"
      fi
  }

  heraser() {
      ## Uses `fzf` to sort through the bash history and let you delete an 
      ## entry.

      choices=$( history | grep --color=none "${@}" | fzf )
      [[ -z "${choices}" ]] && exit 1

      confirm=$(printf "yes\ncancel" | fzf)
      
      if [[ ${confirm} == 'yes' ]]; then
          to_delete=$(awk '{ print $1 }' <<< "${choices}")
          history -d ${to_delete}
      fi
  }

  ispeed() {
      ## Test Internet speed.

      curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py \
      | python -
  }

  nmapbasic() {
      message action "Function <nmapBasic> is <sudo grc nmap -sV -O -sC --traceroute ${*}> ..."
      sleep 2
      sudo grc nmap -sV -O -sC --traceroute ${@}
  }

  nowutc() {

      echo  $(date --utc "+%F %H:%M:%S %Z")
  }

  ports() {

      message action "Function <ports> is <sudo netstat -tulanp> ..."
      sudo netstat -tulanp
  }

  psbasic() {

      message action "Function <psbasic> is <ps aux> ..."
      ps aux
  }

  psgrep() {
      message action "Function <psgrep> is <ps aux | grep -Ei "$@"> ..."
      ps aux | grep -Ei "$@"
  }

  pyclean () {
      ## ref. https://stackoverflow.com/a/41386937/10500496  
      find . -type f -name '*.py[co]' -delete -o -type d -name __pycache__ -delete
  }

  pywebserver() {
      message action "Function <pywebserver> is <python -m http.server> ..."
      message result "Starting web server ..."
      python -m http.server
  }

  scannet() {
      message action "<scanNet> will run:"
      message result "sudo rustscan -a ${1} -- -sV -O -sC --traceroute -Pn"
      sleep 2
      sudo rustscan -a ${1} -- -sV -O -sC --traceroute -Pn
  }

  searchcontent() {
    #:- src. https://github.com/junegunn/fzf/wiki/Examples#searching-file-contents

    rg --files-with-matches --no-messages "$1" \
    | fzf --preview "highlight -O ansi -l {} 2> /dev/null | rg --colors 'match:bg:yellow' --ignore-case --pretty --context 10 '$1' || rg --ignore-case --pretty --context 10 '$1' {}"
  }
  alias sc="searchcontent"

  tagalog() {

      wget -U "Mozilla/5.0" -qO - "http://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=tl&dt=t&q=${@}" \
      | awk -F '"' '{print $2}'                                               \
      | head -n 1
  }

  translate() {
      ## Add language abbr after string to translate.
      ## For example, translate "Hello world" fr

      wget -U "Mozilla/5.0" -qO - "http://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${2}&dt=t&q=${1}" \
      | awk -F '"' '{print $2}'                                               \
      | head -n 1
  }

  tunsrc() {

      message action "Reading tunnels..."
      message title "INT\tIP ADDR   \tPID\tNAME"
      while read -r _interface; do

        _ip=$(grep -oP '(?<=inet )(.*)(?=/)' <<<"${_interface}")
        _tun=$(awk '{ print $NF }' <<<"${_interface}")
        _ps=$(sudo grep -r $_tun /proc/*/fdinfo 2>/dev/null | cut -d / -f 3)
        _cmd="$(ps -o cmd --no-headers ${_ps})"

        if [[ $(awk '/openvpn/ && /server/' <<< ${_cmd}) ]]; then
          _tunname="OpenVPNServer"
        elif [[ $(awk '/openvpn/ && /tryhackme/' <<< "${_cmd}") ]]; then
          _tunname="TryHackMe"
        elif [[ $(awk '/nordvpn/' <<< "${_cmd}") ]]; then
          _tunname="NordVPN"
        else
          _tunname="UNDEFINED"
        fi

        printf "%b\n" "${_tun}\t${_ip}\t${_ps}\t${_tunname}"

      done <<< $(ip a | grep -E 'inet [1-9].*global.*(tun)')
  }

  viewips() {

      message action "Current IP addresses:"
      ip address | grep "inet [1-9]" | awk '{ print $NF "\t" $2 }'
  }

  whoisweb() {

      ## Query the web if `whois` port 43 is blocked on your network.

      curl --silent https://whoisjs.com/api/v1/${1}                           \
      | jq ".raw"                                                             \
      | sed "s/\\\r\\\n/\\n/g"

  }

## FIN _____________________________________________________________ ¯\_(ツ)_/¯
# vim: syntax=sh
